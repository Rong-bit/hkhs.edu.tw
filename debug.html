<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç–«èª¿ç³»çµ±è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagnostic-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { 
            background-color: #d4edda; 
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 10px 0;
        }
        .error { 
            background-color: #f8d7da; 
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 10px 0;
        }
        .warning { 
            background-color: #fff3cd; 
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
        }
        .info { 
            background-color: #d1ecf1; 
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 10px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .step-number {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç–«èª¿ç³»çµ±è¨ºæ–·å·¥å…·</h1>
    <p>é€™å€‹å·¥å…·æœƒå¹«æ‚¨é€æ­¥è¨ºæ–·å’Œè§£æ±º API é€£ç·šå•é¡Œ</p>

    <div class="diagnostic-section">
        <h2>æ­¥é©Ÿ 1: è¨­å®š API URL</h2>
        <div class="step">
            <span class="step-number">1</span>
            <strong>è«‹è¼¸å…¥æ‚¨çš„ Google Apps Script API URLï¼š</strong>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec" style="width: 100%; margin: 10px 0;">
            <button onclick="saveApiUrl()">å„²å­˜ URL</button>
            <div id="urlStatus"></div>
        </div>
    </div>

    <div class="diagnostic-section">
        <h2>æ­¥é©Ÿ 2: åŸºæœ¬é€£ç·šæ¸¬è©¦</h2>
        <div class="step">
            <span class="step-number">2</span>
            <strong>æ¸¬è©¦åŸºæœ¬ç¶²é å­˜å–ï¼š</strong>
            <button onclick="testBasicAccess()" id="basicTestBtn">æ¸¬è©¦åŸºæœ¬å­˜å–</button>
            <div id="basicResult"></div>
        </div>
        
        <div class="step">
            <span class="step-number">3</span>
            <strong>æ¸¬è©¦ API ç«¯é»ï¼š</strong>
            <button onclick="testApiEndpoint()" id="apiTestBtn" disabled>æ¸¬è©¦ API ç«¯é»</button>
            <div id="apiResult"></div>
        </div>
    </div>

    <div class="diagnostic-section">
        <h2>æ­¥é©Ÿ 3: è©³ç´°è¨ºæ–·</h2>
        <div class="step">
            <span class="step-number">4</span>
            <strong>åŸ·è¡Œå®Œæ•´è¨ºæ–·ï¼š</strong>
            <button onclick="runFullDiagnostic()" id="diagnosticBtn" disabled>åŸ·è¡Œè¨ºæ–·</button>
            <div id="diagnosticResult"></div>
        </div>
    </div>

    <div class="diagnostic-section">
        <h2>æ­¥é©Ÿ 4: ä¿®å¾©å»ºè­°</h2>
        <div id="fixSuggestions"></div>
    </div>

    <div class="diagnostic-section">
        <h2>æ­¥é©Ÿ 5: æ¸¬è©¦è¡¨å–®æäº¤</h2>
        <div class="step">
            <span class="step-number">5</span>
            <strong>æ¸¬è©¦è¡¨å–®æäº¤åŠŸèƒ½ï¼š</strong>
            <button onclick="testFormSubmit()" id="submitTestBtn" disabled>æ¸¬è©¦è¡¨å–®æäº¤</button>
            <div id="submitResult"></div>
        </div>
    </div>

    <script>
        let API_URL = '';
        let diagnosticResults = {};

        function saveApiUrl() {
            API_URL = document.getElementById('apiUrl').value.trim();
            if (!API_URL) {
                document.getElementById('urlStatus').innerHTML = '<div class="error">è«‹è¼¸å…¥ API URL</div>';
                return;
            }
            
            if (!API_URL.includes('script.google.com')) {
                document.getElementById('urlStatus').innerHTML = '<div class="warning">URL æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºï¼Œè«‹ç¢ºèªé€™æ˜¯ Google Apps Script çš„ URL</div>';
            } else {
                document.getElementById('urlStatus').innerHTML = '<div class="success">âœ… URL å·²å„²å­˜</div>';
                document.getElementById('apiTestBtn').disabled = false;
                document.getElementById('diagnosticBtn').disabled = false;
                document.getElementById('submitTestBtn').disabled = false;
            }
        }

        async function testBasicAccess() {
            const btn = document.getElementById('basicTestBtn');
            const resultDiv = document.getElementById('basicResult');
            
            btn.disabled = true;
            btn.textContent = 'æ¸¬è©¦ä¸­...';
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æ¸¬è©¦åŸºæœ¬å­˜å–...</div>';

            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const text = await response.text();
                    if (text.includes('ç–«èª¿') || text.includes('è¡¨å–®')) {
                        resultDiv.innerHTML = '<div class="success">âœ… åŸºæœ¬å­˜å–æˆåŠŸï¼å¯ä»¥æ­£å¸¸è¼‰å…¥ç–«èª¿è¡¨å–®é é¢</div>';
                        diagnosticResults.basicAccess = true;
                    } else {
                        resultDiv.innerHTML = '<div class="warning">âš ï¸ é€£ç·šæˆåŠŸä½†å…§å®¹ä¸æ­£ç¢ºï¼Œå¯èƒ½ä¸æ˜¯ç–«èª¿ç³»çµ±é é¢</div>';
                        diagnosticResults.basicAccess = false;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ é€£ç·šå¤±æ•—ï¼šHTTP ${response.status} ${response.statusText}</div>`;
                    diagnosticResults.basicAccess = false;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ é€£ç·šéŒ¯èª¤ï¼š${error.message}</div>`;
                diagnosticResults.basicAccess = false;
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ¸¬è©¦åŸºæœ¬å­˜å–';
            }
        }

        async function testApiEndpoint() {
            const btn = document.getElementById('apiTestBtn');
            const resultDiv = document.getElementById('apiResult');
            
            btn.disabled = true;
            btn.textContent = 'æ¸¬è©¦ä¸­...';
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æ¸¬è©¦ API ç«¯é»...</div>';

            try {
                const response = await fetch(API_URL + '?action=getForm', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const text = await response.text();
                    if (text.includes('form-group') || text.includes('input')) {
                        resultDiv.innerHTML = '<div class="success">âœ… API ç«¯é»æ­£å¸¸ï¼å¯ä»¥ç²å–è¡¨å–® HTML</div>';
                        diagnosticResults.apiEndpoint = true;
                    } else {
                        resultDiv.innerHTML = '<div class="warning">âš ï¸ API å›æ‡‰æˆåŠŸä½†å…§å®¹æ ¼å¼ä¸æ­£ç¢º</div>';
                        diagnosticResults.apiEndpoint = false;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ API ç«¯é»å¤±æ•—ï¼šHTTP ${response.status}</div>`;
                    diagnosticResults.apiEndpoint = false;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ API ç«¯é»éŒ¯èª¤ï¼š${error.message}</div>`;
                diagnosticResults.apiEndpoint = false;
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ¸¬è©¦ API ç«¯é»';
            }
        }

        async function runFullDiagnostic() {
            const btn = document.getElementById('diagnosticBtn');
            const resultDiv = document.getElementById('diagnosticResult');
            
            btn.disabled = true;
            btn.textContent = 'è¨ºæ–·ä¸­...';
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨åŸ·è¡Œå®Œæ•´è¨ºæ–·...</div>';

            const tests = [
                { name: 'åŸºæœ¬é€£ç·š', test: () => fetch(API_URL) },
                { name: 'API ç«¯é»', test: () => fetch(API_URL + '?action=getForm') },
                { name: 'CORS è¨­å®š', test: () => fetch(API_URL, { method: 'OPTIONS' }) }
            ];

            let results = [];
            
            for (const test of tests) {
                try {
                    const response = await test.test();
                    results.push({
                        name: test.name,
                        success: response.ok,
                        status: response.status,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                } catch (error) {
                    results.push({
                        name: test.name,
                        success: false,
                        error: error.message
                    });
                }
            }

            // é¡¯ç¤ºè¨ºæ–·çµæœ
            let html = '<h3>è¨ºæ–·çµæœï¼š</h3>';
            results.forEach(result => {
                if (result.success) {
                    html += `<div class="success">âœ… ${result.name}: æ­£å¸¸ (HTTP ${result.status})</div>`;
                } else {
                    html += `<div class="error">âŒ ${result.name}: ${result.error || 'å¤±æ•—'}</div>`;
                }
            });

            resultDiv.innerHTML = html;
            
            // ç”Ÿæˆä¿®å¾©å»ºè­°
            generateFixSuggestions(results);
            
            btn.disabled = false;
            btn.textContent = 'åŸ·è¡Œè¨ºæ–·';
        }

        function generateFixSuggestions(results) {
            const suggestionsDiv = document.getElementById('fixSuggestions');
            let suggestions = '<h3>ä¿®å¾©å»ºè­°ï¼š</h3>';

            const basicTest = results.find(r => r.name === 'åŸºæœ¬é€£ç·š');
            const apiTest = results.find(r => r.name === 'API ç«¯é»');
            const corsTest = results.find(r => r.name === 'CORS è¨­å®š');

            if (!basicTest || !basicTest.success) {
                suggestions += `
                    <div class="error">
                        <h4>âŒ åŸºæœ¬é€£ç·šå•é¡Œ</h4>
                        <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
                        <ul>
                            <li>Google Apps Script æœªæ­£ç¢ºéƒ¨ç½²</li>
                            <li>API URL ä¸æ­£ç¢º</li>
                            <li>åŸ·è¡Œæ¬Šé™è¨­å®šéŒ¯èª¤</li>
                        </ul>
                        <p><strong>è§£æ±ºæ–¹æ³•ï¼š</strong></p>
                        <ol>
                            <li>æª¢æŸ¥ Google Apps Script æ˜¯å¦å·²éƒ¨ç½²ç‚ºã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€</li>
                            <li>ç¢ºèªåŸ·è¡Œæ¬Šé™è¨­å®šç‚ºã€Œä»»ä½•äººã€</li>
                            <li>é‡æ–°éƒ¨ç½²ä¸¦è¤‡è£½æ–°çš„ URL</li>
                        </ol>
                    </div>
                `;
            }

            if (!apiTest || !apiTest.success) {
                suggestions += `
                    <div class="error">
                        <h4>âŒ API ç«¯é»å•é¡Œ</h4>
                        <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
                        <ul>
                            <li>Code.gs ä¸­çš„ getFormHTML å‡½æ•¸æœ‰å•é¡Œ</li>
                            <li>doGet å‡½æ•¸æœªæ­£ç¢ºè™•ç† action åƒæ•¸</li>
                        </ul>
                        <p><strong>è§£æ±ºæ–¹æ³•ï¼š</strong></p>
                        <ol>
                            <li>æª¢æŸ¥ Code.gs ä¸­çš„ doGet å‡½æ•¸</li>
                            <li>ç¢ºèª getFormHTML å‡½æ•¸å­˜åœ¨ä¸”æ­£ç¢º</li>
                            <li>é‡æ–°éƒ¨ç½² Google Apps Script</li>
                        </ol>
                    </div>
                `;
            }

            if (!corsTest || !corsTest.success) {
                suggestions += `
                    <div class="warning">
                        <h4>âš ï¸ CORS è¨­å®šå•é¡Œ</h4>
                        <p>é€™å¯èƒ½å°è‡´å‰ç«¯ç„¡æ³•æ­£å¸¸å‘¼å« API</p>
                        <p><strong>è§£æ±ºæ–¹æ³•ï¼š</strong></p>
                        <ol>
                            <li>ç¢ºèª Code.gs ä¸­å·²è¨­å®š CORS æ¨™é ­</li>
                            <li>æª¢æŸ¥ 'Access-Control-Allow-Origin': '*' è¨­å®š</li>
                        </ol>
                    </div>
                `;
            }

            if (basicTest && basicTest.success && apiTest && apiTest.success) {
                suggestions += `
                    <div class="success">
                        <h4>âœ… æ‰€æœ‰æ¸¬è©¦é€šéï¼</h4>
                        <p>æ‚¨çš„ API è¨­å®šæ­£å¸¸ï¼Œå¯ä»¥é€²è¡Œè¡¨å–®æäº¤æ¸¬è©¦ã€‚</p>
                    </div>
                `;
            }

            suggestionsDiv.innerHTML = suggestions;
        }

        async function testFormSubmit() {
            const btn = document.getElementById('submitTestBtn');
            const resultDiv = document.getElementById('submitResult');
            
            btn.disabled = true;
            btn.textContent = 'æ¸¬è©¦ä¸­...';
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æ¸¬è©¦è¡¨å–®æäº¤...</div>';

            const testData = {
                name: 'è¨ºæ–·æ¸¬è©¦',
                id: 'A123456789',
                class: 'ä¸€å¹´ä¸€ç­',
                birthDate: '2000-01-01',
                onsetMonth: '1',
                onsetDay: '1',
                symptoms: 'è¨ºæ–·æ¸¬è©¦ç—‡ç‹€'
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>âœ… è¡¨å–®æäº¤æˆåŠŸï¼</h4>
                            <p>å›æ‡‰è¨Šæ¯ï¼š${result.message}</p>
                            <p>æ‚¨çš„ç–«èª¿ç³»çµ±å·²å®Œå…¨æ­£å¸¸é‹ä½œï¼</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>âŒ è¡¨å–®æäº¤å¤±æ•—</h4>
                            <p>éŒ¯èª¤ï¼š${result.error || 'æœªçŸ¥éŒ¯èª¤'}</p>
                            <p>è«‹æª¢æŸ¥ Google Apps Script çš„ submitForm å‡½æ•¸</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ æäº¤éŒ¯èª¤</h4>
                        <p>éŒ¯èª¤è¨Šæ¯ï¼š${error.message}</p>
                        <p>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå’Œ API è¨­å®š</p>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ¸¬è©¦è¡¨å–®æäº¤';
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„ URL
        window.addEventListener('load', function() {
            const savedUrl = localStorage.getItem('apiUrl');
            if (savedUrl) {
                document.getElementById('apiUrl').value = savedUrl;
                API_URL = savedUrl;
                document.getElementById('apiTestBtn').disabled = false;
                document.getElementById('diagnosticBtn').disabled = false;
                document.getElementById('submitTestBtn').disabled = false;
            }
        });
    </script>
</body>
</html>
